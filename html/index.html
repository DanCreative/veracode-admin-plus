<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veracode Admin Plus</title>
    <link rel="stylesheet" href="/assets/chosen.min.css">
    <link rel="stylesheet" href="/assets/index.css">
    <link rel="stylesheet" href="/assets/table.css">

    <script src="https://unpkg.com/htmx.org@1.9.3"></script>
    <script src="/assets/jquery-3.7.0.min.js"></script>
    <script src="/assets/chosen.jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body>
    <div id="container" class="container" hx-disinherit="*" hx-get="/users" hx-swap="innerHTML" hx-target="this" hx-trigger="load,force" hx-indicator="#load-body">

    </div>

    <div id="load-body" class="htmx-indicator overlay">
        <div id="spinner"></div>
    </div>
    <script>
        htmx.on("htmx:afterOnLoad", function(evt) {
            $(".teams-select").chosen({width: "200px", no_results_text: "No teams found...",placeholder_text_multiple:"Select teams...", display_selected_options: false});
        });
        
        function SubmitRow(userId){
            console.log("userId: "+userId);
            var trId = "#form-"+userId

            var formValues = htmx.values(htmx.find(trId));
            console.log("Form Values: "+ formValues);
            htmx.ajax('PUT', '/cart/users/'+userId, {
                values: formValues
            });
        }

        function AlterRow(trId){
            var tr = $("#" + trId);
            //tr.trigger("submit");
            tr.addClass('altered');
            
            $(".cart-controls").attr("disabled", false);
            console.log("Triggered submit on " + trId);
        }

        function CascadeValues(name){
            console.log("Triggered CascadeValues with " + name);
            $("#filter-options").attr("name", name)
            $("#filter-options").children().each(function(){
                if ($(this).hasClass(name)) {
                    $(this).removeAttr("hidden");
                    //console.log("Removing hidden from " + this);
                } else {
                    $(this).attr("hidden", true);
                    //console.log("Adding hidden to " + this);
                }
            });
        }

        function ShowAdminTeams(sourceId, targetId){
            var teamsSelectVals = $("#" + sourceId).val();
            var admTeamsSelect = $("#" + targetId);
            admTeamsSelect.children().each(function(){
                if (teamsSelectVals.length < 1) {
                    $(this).attr("hidden", true);
                } else {
                    for (let index = 0; index < teamsSelectVals.length; index++) {
                        if (this.value == teamsSelectVals[index]){
                            $(this).removeAttr("hidden");
                        }
                    }
                }
            });
        }

        function TeamAdminModalCheckActive(admteamSelectId, element){
            var checkbox = $(element);
            var button = checkbox.next();

            if (checkbox.is(":checked")) {
                button.addClass("active");
            } else {
                button.removeClass("active");
                $("#"+admteamSelectId).val([]);
            }
        }

        function TeamAdminModal(modalId, element){
            var checkbox = $(element).prev();
            //console.log(checkbox);
            if (checkbox.is(":checked")) {
                console.log(checkbox.attr('id') + " is checked");
                ShowModal(modalId);
            }else {
                console.log(checkbox.attr('id') + " is not checked");
            }
        }
        
        function ShowModal(id){
            console.log("Trying to find modal: " + id);
            var modal = $("#" + id);
            modal.show()
            //modal.style.display = "block";
        }

        function CloseAnyModal() {
            var modals = document.getElementsByClassName("modal");
            for (let index = 0; index < modals.length; index++) {
                const modal = modals[index];
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        }

        function CloseParentModal(el) {
            $(el).closest(".modal").hide();
        }

        function CheckScanTypesEmpty(userId){
            var isEmpty = true
            $(".scan-type.roles-" + userId).each(function() {
                    if ($(this).is(":checked")){
                        isEmpty = false
                    }
            });

            console.log("CheckSanTypesEmpty() -> isEmpty = "+ isEmpty);
            if (isEmpty){
                $("#extsubmitanyscan-" + userId).prop("checked", true);
            }
        }
        
        function AnyScanClicked(el, userId){
            if ($(el).is(":checked")){
                $(".not-any-scan.roles-" + userId).each(function() {
                    $(this).val([]);
                });
            } else {
                CheckScanTypesEmpty(userId);
            }
        }

        function NanyScanClicked(el, userId) {
            if ($(el).is(":checked")){
                $("#extsubmitanyscan-" + userId).val([]);
            } else {
                CheckScanTypesEmpty(userId);
            }
        }
        
        window.onclick = function(event) {
            CloseAnyModal();
        }
    </script>
</body>

</html>